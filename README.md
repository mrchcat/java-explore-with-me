# Explore With Me
Пулреквест:  https://github.com/mrchcat/java-explore-with-me/pull/3

Сервис представляет собой бэкэнд афиши. В этой афише можно предложить какое-либо событие от выставки до похода в кино и собрать компанию для участия в нём.

API основного сервиса состоит из 3 частей:
* публичная будет доступна без регистрации любому пользователю сети;
* закрытая будет доступна только авторизованным пользователям;
* административная — для администраторов сервиса.

Структура базы данных сервиса представлена ниже

**Основной сервис:**

![main service schema](/ewm-service/src/main/resources/schema.png)

**Сервис статистики**

![stat service schema](/statistics/service/src/main/resources/schema.png)

### Основные изменения в ветке feature-comments:
Реализован функционал добавления комментариев к событиям. 

В БД добавлена таблица "comments" c полями:
*  id - первичный ключ
*  state - состояние (активный или удаленный)
*  event_id - событие, к которому относится комментарий
*  author_id - автор комментария 
*  editable - можно ли редактировать комментарий или запрещено
*  text - собственно текст комментария
*  created - дата создания
*  is_modified - становится true после того, как комментарий правили
*  last_modification - дата последнего исправления комментария (или дата создания)

### Endpoints:

**Авторизированный пользователь**

  1) Добавление комментария к событию.

    POST: /users/{userId}/comments?event={ebentId}
    Body: {“text”: “первый !”}
Примечание: 
*	комментировать можно только опубликованные события
*	добавить комментарий можно только  к чужому событию.
*   нельзя более одного раза комментировать одно и то же событие
*	объем комментария должен составлять от 1 до 10 тыс знаков.

  2) Удаление комментария (фактически комментарий не удаляется, но становится невидимым для пользователя).

    DELETE: /users/{userId}/comments/{commentId}
        
Примечание:
*	"удалять" можно только комментарии к опубликованным событиям
*	"удалить" можно только свой комментарий, у которого поле editable установлено в true и state=ALIVE
*    после "удаление" комментария, поле state устанавливается в DEAD, поле editable - в false;

  3) Редактирование комментария по его id
      
    PATCH: /users/{userId}/comments/{commentId} 
    Body: {“text”: “старый комментарий был плох, поэтому я решил его переписать”}

Примечание:
      *	редактировать можно только комментарии к опубликованным событиям
      *	редактировать можно только свой комментарий, у которого поле editable установлено в true статус ALIVE
      *	объем комментария должен составлять от 1 до 10 тыс знаков.

**Администратор**

  1) Изменение свойств комментария

    PATCH /admin/comments/{commentId}
    Body: {“state”: “ALIVE ”, “editable”: “false”}

  Примечание:
   * при выставлении статуса DEAD, поле editable устанавливается в false

  2) Удалить комментарий (удаляется сама запись в БД)

    DELETE /admin/comments/{commentId}

  3) Просмотр всех комментариев, удовлетворяющих параметрам

    GET:/admin/comments?comment={commentId}&commentState={commentState}&event={eventId}&eventState={eventState}&user={userId}&editable={true;false}&text={text}&start={start}&end={end}&order={ASC;DESC}&”from”={from}&”size”={size}
   *	comment – список номеров комментариев
   *	commentState -статус комментария (по умолчанию ALIVE)
   *	event – список номеров событий
   *	user – список номеров пользователей – авторов комментариев
   *	editable- возможность редактировать комментарий
   *	text – строка поиска . Поиск в нижнем регистре без окаймляющих пробелов.
   *	start, end – интервал времени последнего изменения;
   *	order   - порядок сортировки по дате
   *	from  - номер страницы (по умолчанию 0)
   *	size – размер страницы (по умолчанию 10)
   
   Все параметры необязательные.

**Публичный доступ**

  1)	просмотр всех комментариев со статусом ALIVE для конкретного события (с сортировкой по дате последней модификации)
 
      GET/comments?query={eventId}&sort={ASC,DESC}

### Тесты Postman:
Обратите внимание, что создание вспомогательных сущностей происходит через запросы в папке "Подготовка объектов". 
Остальные папки содержат тесты, сгруппированные по контроллерам.
Порядок запуска тестов имеет значение, т.к. в процессе работы созданные сущности изменяются, что оказывает влияние на последующие тесты. 
Запускать пакет "Comments" следует целиком. 