# Explore With Me

Сервис представляет собой бэкэнд афиши. В этой афише можно предложить какое-либо событие от выставки до похода в кино и собрать компанию для участия в нём.

Версия: Java 21

Зависимости: Spring Boot, Hibernate, драйвер Postgres, Maven, Querydsl, Lombok, логирование logback, zalando

Развертывание приложения происходит в 4 docker-контейнерах: база данных основного сервиса, основной сервис, база данных сервиса статистики, сервис статистики.   
Для создания контейнеров и запуска приложения предназначен файл docker-compose.

API основного сервиса состоит из 3 частей:
* публичная будет доступна без регистрации любому пользователю сети;
* закрытая будет доступна только авторизованным пользователям;
* административная — для администраторов сервиса.

Статистика обращений к событиям в публичной части сохраняются в сервисе статистики. 

Структура базы данных сервиса представлена ниже

**Основной сервис:**

![main service schema](/ewm-service/src/main/resources/schema.png)

**Сервис статистики**

![stat service schema](/statistics/service/src/main/resources/schema.png)

### Endpoints:

**Авторизированный пользователь**

***События***

  1) Создать событие
        
    POST: /users/{userId}/events
    Body: {"title": Рыбалка", "annotation": "Зимняя рыбалка на Каме", "description":"рыбалка с мормышкой", "category":1, "eventDate":2024-12-01 12:12:12, "participantLimit":10}

  2) Обновить событие

    PATCH: /users/{userId}/events
    Body: {"stateAction":"SEND_TO_REVIEW" ,"eventDate":"2024-03-14 01:01:01"}

  3) получить все события, инициатором которых является конкретный пользователь

    GET: /users/{userId}/events?from=11&size=54
   * from  - номер страницы (по умолчанию 0)
   * size – размер страницы (по умолчанию 10)

  4) Получить конкретное событие, инициатором которых является конкретный пользователь

    GET: /users/{userId}/events/{eventId}
   * userId - номер пользователя
   * from  - номер страницы (по умолчанию 0)
   * size – размер страницы (по умолчанию 10)

**Запрос на участие в событии***

  1) Создать запрос на участие в событии

    POST: /users/{userId}/requests?eventId=1231

  2) Отменить запрос на участие

    PATCH: /users/{userId}/requests/{requestId}/cancel

  3) Получить все запросы на участие для конкретного пользователя, который их запрашивал 

    GET: /users/{userId}/events/{eventId}/requests

  4) Ответить на запрос на участия в событии

    PATCH: /users/{userId}/events/{eventId}/requests
    Body: {"requestIds": 1,2,33, "status": "CONFIRMED"}

***Комментарии***

  1) Добавление комментария к событию.

    POST: /users/{userId}/comments?event={ebentId}
    Body: {“text”: “первый !”}
Примечание: 
*	комментировать можно только опубликованные события
*	добавить комментарий можно только  к чужому событию.
*   нельзя более одного раза комментировать одно и то же событие
*	объем комментария должен составлять от 1 до 10 тыс знаков.

  2) Удаление комментария (фактически комментарий не удаляется, но становится невидимым для пользователя).

    DELETE: /users/{userId}/comments/{commentId}
        
Примечание:
*	"удалять" можно только комментарии к опубликованным событиям
*	"удалить" можно только свой комментарий, у которого поле editable установлено в true и state=ALIVE
*    после "удаление" комментария, поле state устанавливается в DEAD, поле editable - в false;

  3) Редактирование комментария по его id
      
    PATCH: /users/{userId}/comments/{commentId} 
    Body: {“text”: “старый комментарий был плох, поэтому я решил его переписать”}

Примечание:
*	редактировать можно только комментарии к опубликованным событиям
*	редактировать можно только свой комментарий, у которого поле editable установлено в true статус ALIVE
*	объем комментария должен составлять от 1 до 10 тыс знаков.
*   статус комментария, таким образом, может быть следующим:
    * запись существует в БД
       * видимая пользователю (state=ENABLE), пользователь может ее редактировать и удалять (editable=true)
       * видимая пользователю (state=ENABLE), возможность для изменения и удаления записи пользователю закрыта (editable=false) 
    * запись удалена из БД  


**Администратор**

***Пользователи***

  1) Создать пользователя

    POST: /admin/users
    Body: {"name": "Ivan", “email”: “iban@mail.ru”}    

  2) Удалить пользователя

    DELETE: /admin/users/{userId}

  3) Получить всех пользователей

    GET: /admin/users?ids=1,323,2233&from=15&size=15

***Категории***

  1) Создать категорию

    POST: /admin/categories
    Body: {"name": "поход в театр" }

  2) Удалить категорию

    DELETE: /admin/categories/{categoryId}

  3) Обновить категорию

    PATCH: /admin/categories/{categoryId}
    Body: {"name": "замняя рыбалка"}

***События***

  1) Изменить конкретное событие

    PATCH: /admin/events/{eventId}
    Body: {"stateAction": "PUBLISH_EVENT", "eventDate": "2024-03-14 01:01:01"}

  2) Получить все события

    GET: /admin/events?users=1,3,45&states=CANCELED&categories=1,3&rangeStart=2024-03-14 01:01:01&rangeEnd=2025-03-14 01:01:01
   *    users - список пользователей 
   *    states - список состояний событий
   *    categories -  список категорий
   *    rangeStart - начальная дата поиска событий
   *    rangeEnd - конечная дата поиска событий 
   *    from  - номер страницы (по умолчанию 0)
   *	size – размер страницы (по умолчанию 10)

***Подборки событий***

  1) Создать подборку событий

    POST: /admin/compilations
    Body: {“title”: “Все про кино ”, “events”: 13, 312,2121, "pinned"=true}

  2) Удалить подборку событий

    DELETE: /admin/compilations/{compilationId}

  3) Изменить подборку событий

    PATCH: /admin/compilations/{compilationId}

***Комментарии***

  1) Изменение свойств комментария

    PATCH: /admin/comments/{commentId}
    Body: {“state”: “ALIVE ”, “editable”: “false”}

  Примечание:
   * при выставлении статуса DISABLE, поле editable устанавливается в false

  2) Удалить комментарий (удаляется сама запись в БД)

    DELETE /admin/comments/{commentId}

  3) Просмотр всех комментариев, удовлетворяющих параметрам

    GET:/admin/comments?comment={commentId}&commentState={commentState}&event={eventId}&eventState={eventState}&user={userId}&editable={true;false}&text={text}&start={start}&end={end}&order={ASC;DESC}&”from”={from}&”size”={size}
   *	comment – список номеров комментариев
   *	commentState -статус комментария
   *	event – список номеров событий
   *	user – список номеров пользователей – авторов комментариев
   *	editable- возможность редактировать комментарий
   *	text – строка поиска . Поиск в нижнем регистре без окаймляющих пробелов.
   *	start, end – интервал времени последнего изменения;
   *	order   - порядок сортировки по дате
   *	from  - номер страницы (по умолчанию 0)
   *	size – размер страницы (по умолчанию 10)
   
   Все параметры необязательные.


**Публичный доступ**

***Категории***

  1) получить все категории

    GET/categories?from=1&size=10

  2) получить категорию по ее id   

    GET/categories/{categoryId}

***События***
 
  1) Получить все события
   
    GET: /events&text=Кино
   *	text - поисковый запрос
   *	categories - перечень категорий
   *	paid - платное или бесплатное событие
   *	rangeStart - событие в промежутке от указанной даты  
   *	rangeEnd  -  событие в промежутке до указанной даты
   *	onlyAvailable - искать только события, для которых не исчерпан лимит участников
   *	sort - порядок сортировки
   *	from - начальная позиция 
   *	size  - размер выдачи

  2) Получить конкретное событие
   
    GET: /events/{eventId}

***Подборки событий***
  
  1) Получить все подборки событий

    GET: /compilations

  2) Получить конкретную подборку событий

    GET: /compilations/{compilationId}

***Комментарии***

  1)	просмотр всех комментариев со статусом ENABLE для конкретного события (с сортировкой по дате последней модификации)
 
    GET/comments?query={eventId}&sort={ASC,DESC}



### Тесты Postman:
Создание вспомогательных сущностей происходит через запросы в папке "Подготовка объектов", остальные папки содержат тесты, сгруппированные по контроллерам.
Порядок запуска тестов имеет значение, т.к. в процессе работы созданные сущности изменяются, что оказывает влияние на последующие тесты. 
Запускать пакет "Comments" следует целиком.  